#!/usr/bin/env python3
# $hgid:
#
# Find files that don't end with a newline, and add one
#
# TODO:
# http://stackoverflow.com/questions/6119956/how-to-determine-if-git-handles-a-file-as-binary-or-as-text

import os

def last(fname):
    if os.stat(fname).st_size == 0:
        return b'\n'

    with open(fname, 'rb') as fp:
        fp.seek(-1, 2)
        return fp.read(1)


for root, dirs, files in os.walk('.'):
    for f in files:
        if f.split('.').pop() in ['png', 'jpg', 'jpeg', 'gif', 'pdf', 'ico']:
            continue

        f = '%s/%s' % (root, f)
        if last(f) != b'\n':
            print(f)
            with open(f, 'ab') as fp:
                fp.write(b'\n')

print(
    """WARNING: We didn't do an extensive check if a file was binary; please
make sure no binary files were modified""")
