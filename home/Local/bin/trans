#!/bin/sh
# $hgid:
#
# Translate text using google. No google account needed.
#
# Supported language codes
# af ar az be bn bg bs ca cub zh-CN zh-TW cs cy da de en en_us en_gb en_au 
# el es et eu fa fi fr ga gl gu ht hi hmn hr hu hy is id it iw ja jw ka km 
# kn ko la lv lt mk mr ms mt no nl pl pt ro ru sr sk sl sq sw sv ta te th tl 
# tr uk ur vi yi
#

# Language code aliases for convenience
languages="
de:german duits
en:english engels
fr:french frans
nl:dutch nederlands
"

usage() {
	[ ! -z "$1" ] && echo "$1"

	echo "Usage: ${0##*/} [input language] [output language]"
	echo "       Translation string is read from stdin"

	[ ! -z "$1" ] && exit 1 || exit 0
}

[ -z $1 ] && usage
[ -z $2 ] && usage "No output language"
$(which curl > /dev/null) || usage "We need curl"
$(which iconv > /dev/null) || usage "We need iconv"
$(which python > /dev/null) || usage "We need python"

langin=$1
langout=$2

IFS="
"
for lang in $languages; do
	aliases=$(echo "$lang" | cut -d: -f2)
	lang=$(echo "$lang" | cut -d: -f1)
	IFS=" "
	for alias in $aliases; do
		[ "$langin" = "$alias" ] && langin=$lang
		[ "$langout" = "$alias" ] && langout=$lang
	done
done

text=""
while read line; do
	text="${text}
${line}"
done

html=$(curl -s -i --user-agent "" \
	-d "sl=$langin" -d "tl=$langout" --data-urlencode "text=$text" \
	http://translate.google.com)
encoding=$(echo "$html" | grep -m1 '^Content-Type:' | cut -d= -f2 | tr -d '[[:space:]]')

echo "$html" \
	| iconv -f $encoding \
	| sed -n "s/.*TRANSLATED_TEXT='\(.*\)';INP.*/\1/p;" \
	| sed 's/\\x3cbr\\x3e/\
/g' \
	| python -c 'import sys; print sys.stdin.read().replace(r"\x3cbr\x3e", "\n").strip()'
